<!-- Messages area -->
{% load static %}
<div id="chat-messages" class="space-y-5 mb-4 min-h-[calc(100vh-180px)]">
	{% for msg in conversation %}
	<div class="message-enter px-4 md:px-6 py-6">
		{% if msg.role == "user" %}
		<!-- User message - right aligned -->
		<div
			class="chat-container flex flex-row-reverse gap-4 md:gap-6 justify-start">
			<!-- User icon - right side -->
			<!-- Message content -->
			<div class="overflow-x-auto max-w-[75%]">
				<div
					class="user-message text-gray-100 bg-[#334155] p-3 rounded-lg message-text-container"
					data-message-id="{{ msg.id }}" data-created-at="{{ msg.created_at }}">
					<p class="whitespace-pre-wrap message-content-text">{{ msg.text }}</p>
					<div class="edit-controls hidden mt-2">
						<textarea
							class="edit-message-textarea w-full p-2 rounded bg-gray-700 border border-gray-600 text-gray-100 resize-none"
							rows="3"></textarea>
						<div class="flex justify-end gap-2 mt-2">
							<button
								class="cancel-edit-btn px-3 py-1 text-xs bg-gray-600 hover:bg-gray-500 rounded text-white">Cancel</button>
							<button
								class="save-edit-btn px-3 py-1 text-xs bg-blue-600 hover:bg-blue-500 rounded text-white">Save</button>
						</div>
					</div>
					{% if msg.is_edited %}
					<span class="text-xs text-gray-400 italic ml-1">(edited)</span>
					{% endif %}
				</div>
				<!-- Edit button moved here, under the message box -->
				<div class="flex justify-end mt-1 pr-1">
					<button
						class="edit-message-btn p-1 text-gray-400 hover:text-gray-200 transition-opacity"
						data-message-id="{{ msg.id }}" title="Edit message">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
							viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round"
								d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
						</svg>
					</button>
				</div>
			</div>
		</div>
		{% else %}
		<!-- Assistant message - left aligned -->
		<div class="chat-container flex gap-4 md:gap-6">
			<!-- Assistant icon - left side -->
			<div class>
				<div
					class="w-24 flex items-center justify-center text-white">
					<img src="{% static 'images/logo.png' %}" alt="Assistant icon"
						class="h-20 w-20 ">
				</div>
			</div>
			<!-- Message content -->
			<div class="block overflow-x-auto min-w-[65%] max-w-[85%]">
				{% if msg.type == 'diagram' and msg.diagram_image_url %}
				<div
					class="diagram-message-container borderd border-red-600 shadow-md shadow-gray-900 bg-gray-800/50 p-2 my-2 rounded-lg shadow-md flex flex-col justify-center items-center">
					<img src="{{ msg.diagram_image_url }}"
						alt="{{ msg.text | default:'Generated Diagram' }}"
						class="max-w-full h-auto rounded-md mb-1 cursor-pointer hover:opacity-90 transition-opacity"
						onclick="openImageModal('{{ msg.diagram_image_url }}')">
					{% if msg.text %}
					<p class="text-xs text-gray-400 italic mt-1 text-center">{{ msg.text }}</p>
					{% endif %}
				</div>
				{% elif msg.type == 'youtube' and msg.structured_content %}
				<div class="youtube-recommendations-container space-y-3">
					<p class="text-gray-200">{{ msg.text }}</p>
					{% for video in msg.structured_content %}
					<a href="{{ video.url }}" target="_blank" rel="noopener noreferrer"
						class="flex items-center bg-gray-800/50 hover:bg-gray-700/60 border border-gray-700 rounded-lg p-2 no-underline transition-all duration-200 group">
						<div class="flex-shrink-0 w-32 h-18 mr-3">
							<img src="{{ video.thumbnail }}" alt="Thumbnail for {{ video.title }}"
								class="w-full h-full object-cover rounded-md border border-gray-600">
						</div>
						<div class="flex-1 min-w-0">
							<p
								class="text-gray-100 font-medium text-sm truncate group-hover:text-white">{{video.title }}</p>
						</div>
					</a>
					{% endfor %}
				</div>
				{% else %}
				{% if msg.text %}
				<div class="max-w-none markdown-content text-gray-100">
					{{ msg.text |safe }}
				</div>
				{% endif %}
				{% if msg.html %}
				<div
					class="quiz-message max-w-none text-gray-100 bg-gray-700/70 p-2 rounded-xl mt-2">
					{{ msg.html | safe }}
				</div>
				{% endif %}
				{% endif %}
			</div>
		</div>
		{% endif %}
	</div>
	{% empty %}
	<div id="initial-chat-placeholder"
		class="flex flex-col items-center justify-center h-[calc(100vh-200px)] ">
		<img src="{% static 'images/logo.png' %}" alt="Assistant icon"
			class="h-36 w-36">

		<p class="text-gray-400 text-sm">How can I help you today?</p>
	</div>
	{% endfor %}
</div>
