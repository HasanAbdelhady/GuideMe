name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: read
  issues: read
  statuses: read

jobs:
  # PR Validation
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
          requireScope: false

      - name: Check for merge conflicts
        run: |
          # Check for merge conflicts
          if git merge-tree $(git merge-base HEAD main) HEAD main 2>/dev/null | grep -q "<<<<<<< "; then
            echo "::error::Merge conflicts detected. Please resolve conflicts before merging."
            exit 1
          else
            echo "âœ… No merge conflicts detected"
          fi

      - name: Validate file changes
        run: |
          # Check if requirements.txt was modified
          if git diff --name-only main...HEAD | grep -q "requirements.txt"; then
            echo "::warning::requirements.txt was modified. Make sure to update the changelog."
          fi

          # Check for large files
          git diff --name-only main...HEAD | while read file; do
            if [ -f "$file" ]; then
              # Use cross-platform file size check
              size=$(wc -c < "$file" 2>/dev/null || echo 0)
              if [ "$size" -gt 1048576 ]; then
                echo "::error::File $file is larger than 1MB ($size bytes)"
                exit 1
              fi
            fi
          done

  # Code Quality Gate
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt

      - name: Check code complexity
        run: |
          # Check cyclomatic complexity
          python -m mccabe --min 10 . || true

          # Check for TODO/FIXME comments in new code
          git diff main...HEAD --name-only | xargs grep -l "TODO\|FIXME" || true

      - name: Check test coverage diff
        run: |
          # This would compare test coverage between main and PR branch
          echo "Checking test coverage diff..."
          # Add coverage comparison logic here

  # Database Migration Check
  migration-check:
    name: Database Migration Check
    runs-on: ubuntu-latest

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_guideme
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Apply main branch migrations
        run: |
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_guideme" > .env
          echo "SECRET_KEY=test-key" >> .env
          python manage.py migrate --noinput

      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Install PR branch dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Check for migration conflicts
        run: |
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/test_guideme" > .env
          echo "SECRET_KEY=test-key" >> .env
          python manage.py makemigrations --check --dry-run

      - name: Test forward migrations
        run: |
          python manage.py migrate --noinput

      - name: Test reverse migrations (if any)
        run: |
          # Test that migrations can be reversed (for rollback safety)
          python manage.py showmigrations
          # Add specific rollback tests here if needed

  # Security Check for Dependencies
  dependency-security:
    name: Dependency Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Install safety
        run: |
          pip install safety==3.6.0
          pip install pydantic==2.9.2

      - name: Check for known security vulnerabilities
        run: |
          safety check -r requirements.txt --json --output safety-report.json

      - name: Upload safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-report
          path: safety-report.json

  # Performance Impact Check
  performance-impact:
    name: Performance Impact Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for performance-sensitive changes
        run: |
          # Check if database models were modified
          if git diff --name-only main...HEAD | grep -q "models.py"; then
            echo "::warning::Database models were modified. Consider performance impact."
          fi

          # Check if views were modified
          if git diff --name-only main...HEAD | grep -q "views.py"; then
            echo "::warning::Views were modified. Consider performance impact."
          fi

          # Check for N+1 query patterns in new code
          git diff main...HEAD | grep -E "\.get\(|\.filter\(" || true

  # Documentation Check
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for README updates
        run: |
          # If significant features were added, README should be updated
          if git diff --name-only main...HEAD | grep -q "views.py\|models.py\|urls.py"; then
            if ! git diff --name-only main...HEAD | grep -q "README.md"; then
              echo "::warning::Significant code changes detected. Consider updating README.md"
            fi
          fi

      - name: Check for docstring coverage
        run: |
          pip install interrogate
          interrogate -v --fail-under=80 .

  # Frontend Asset Check
  frontend-check:
    name: Frontend Asset Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Check for CSS/JS changes
        run: |
          if git diff --name-only main...HEAD | grep -E "\.(css|js|html)$"; then
            echo "Frontend assets were modified"
            # Add frontend linting/testing here if needed
          fi

      - name: Check static file size
        run: |
          # Check if static files are too large
          find . -name "*.css" -o -name "*.js" | while read file; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file" 2>/dev/null || echo 0)
              if [ "$size" -gt 102400 ]; then  # 100KB
                echo "::warning::Static file $file is larger than 100KB ($size bytes)"
              fi
            fi
          done
